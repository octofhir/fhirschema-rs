# .output Directory Structure Documentation

## Overview

The `.output` directory provides a centralized, structured location for all FHIRSchema CLI operations, making debugging and file management significantly easier. All downloaded packages, converted schemas, raw files, and metadata are organized in a logical hierarchy.

## Directory Structure

```
.output/
├── downloads/                          # Downloaded package files
│   ├── packages/                       # Original package archives
│   │   └── {package-id}-{version}.tgz  # Raw package files (e.g., hl7.fhir.r4.core-4.0.1.tgz)
│   └── extracted/                      # Extracted package contents (for debugging)
│       └── {package-id}-{version}/     # Package-specific extraction directory
├── converted/                          # Global converted files directory
│   ├── ndjson/                        # NDJSON format conversions
│   ├── json/                          # JSON format conversions
│   └── yaml/                          # YAML format conversions
├── packages/                          # Package-specific organized files
│   └── {package-id}-{version}/        # Individual package directory
│       ├── raw/                       # Original StructureDefinition files
│       │   └── *.json                 # Individual StructureDefinition files
│       ├── converted/                 # Converted FHIRSchema files
│       │   ├── schemas.ndjson         # All schemas in NDJSON format
│       │   ├── schemas.json           # All schemas in JSON array format
│       │   └── schemas.yaml           # All schemas in YAML format
│       └── metadata/                  # Package processing metadata
│           └── summary.json           # Processing summary and statistics
└── logs/                              # Processing logs (future use)
```

## File Organization Examples

### FHIR R4 Core Package (hl7.fhir.r4.core#4.0.1)
```
.output/packages/hl7.fhir.r4.core-4.0.1/
├── raw/                               # 658 original StructureDefinition files
│   ├── StructureDefinition-Patient.json
│   ├── StructureDefinition-Observation.json
│   └── ... (656 more files)
├── converted/                         # Converted FHIRSchema files
│   └── schemas.ndjson                 # 655 converted schemas (2.3MB)
└── metadata/                          # Package metadata
    └── summary.json                   # Processing details and file list
```

### Custom Package Example (hl7.fhir.us.core#6.1.0)
```
.output/packages/hl7.fhir.us.core-6.1.0/
├── raw/                               # Original US Core StructureDefinitions
├── converted/                         # Converted US Core FHIRSchemas
└── metadata/                          # US Core package metadata
```

## Key Benefits

### 1. **Centralized File Management**
- All CLI operations save files to `.output/` directory
- No more scattered files across different directories
- Easy to find and examine all generated content

### 2. **Package Isolation**
- Each package gets its own subdirectory
- No conflicts between different package versions
- Clear separation of different FHIR implementations

### 3. **Format Organization**
- Raw StructureDefinitions preserved for debugging
- Converted schemas available in multiple formats
- Metadata provides processing details and statistics

### 4. **Debugging Workflow**
- Failed conversions can be traced to specific files
- Raw files available for manual inspection
- Processing metadata shows conversion statistics
- Original package archives preserved for re-processing

## Usage Examples

### Download and Convert FHIR R4 Core
```bash
# Downloads to .output/ automatically
just load-r4-core

# View statistics
just show-r4-stats

# Files are organized in:
# .output/packages/hl7.fhir.r4.core-4.0.1/
```

### Load Custom Package
```bash
# Load US Core package
just load-custom-package hl7.fhir.us.core 6.1.0

# Files organized in:
# .output/packages/hl7.fhir.us.core-6.1.0/
```

### Convert Single File
```bash
# Convert to .output directory
./target/release/fhirschema convert -i input.json -f ndjson -o .output/my-conversion.ndjson
```

## Debugging Workflow

### 1. **Identify Failed Conversions**
```bash
# Run conversion and check logs
just load-r4-core

# Failed files are listed with full paths:
# WARN   - package/StructureDefinition-structuredefinition-xml-type.json
```

### 2. **Examine Raw Files**
```bash
# Navigate to raw files directory
cd .output/packages/hl7.fhir.r4.core-4.0.1/raw/

# Examine specific failed file
cat StructureDefinition-structuredefinition-xml-type.json | jq '.'
```

### 3. **Check Processing Metadata**
```bash
# View processing summary
cat .output/packages/hl7.fhir.r4.core-4.0.1/metadata/summary.json | jq '.'

# Shows:
# - Total files processed
# - Processing timestamp
# - Complete file list
```

### 4. **Compare Formats**
```bash
# View converted schemas
head -5 .output/packages/hl7.fhir.r4.core-4.0.1/converted/schemas.ndjson

# Each line is a complete FHIRSchema in JSON format
```

## Statistics and Analysis

### Package Statistics
```bash
# R4 Core statistics
just show-r4-stats

# Shows:
# - Total schemas: 655
# - File size: 2.3M
# - Raw files: 658 StructureDefinitions
# - Schema type breakdown
# - File locations
```

### File Counts
```bash
# Count all files in .output
find .output -type f | wc -l

# Count by type
find .output -name "*.json" | wc -l    # JSON files
find .output -name "*.ndjson" | wc -l  # NDJSON files
find .output -name "*.tgz" | wc -l     # Package archives
```

## Cleanup

### Remove All Generated Files
```bash
# Clean everything
just clean

# Removes entire .output/ directory and examples/
```

### Selective Cleanup
```bash
# Remove specific package
rm -rf .output/packages/hl7.fhir.r4.core-4.0.1/

# Remove only converted files (keep raw files)
rm -rf .output/packages/*/converted/

# Remove only package archives (keep processed files)
rm -rf .output/downloads/
```

## Integration with Development Workflow

### 1. **Version Control**
Add `.output/` to `.gitignore` to avoid committing large generated files:
```gitignore
.output/
```

### 2. **CI/CD Integration**
```bash
# In CI pipeline
just load-r4-core
just show-r4-stats

# Archive .output/ directory for debugging
tar -czf fhirschema-output.tar.gz .output/
```

### 3. **Development Testing**
```bash
# Quick test with immediate cleanup
just load-r4-core && just show-r4-stats && just clean
```

## Advanced Usage

### Skip Download Functionality

The CLI includes intelligent skip download functionality that avoids re-downloading packages that already exist locally:

```bash
# Efficient loading - skips download if package exists
just load-r4-core                    # Uses --skip-download automatically
just load-r5-core                    # Uses --skip-download automatically
just load-custom-package PKG VER     # Uses --skip-download automatically

# Force re-download when needed
just load-r4-core-fresh              # Forces fresh download
just load-r5-core-fresh              # Forces fresh download
just load-custom-package-fresh PKG VER # Forces fresh download

# Direct CLI usage
./target/release/fhirschema download --package "hl7.fhir.r4.core#4.0.1" --skip-download
./target/release/fhirschema download --package "hl7.fhir.r4.core#4.0.1"  # Force download
```

**Benefits:**
- **Faster execution**: Skip download saves significant time for large packages
- **Bandwidth efficiency**: Avoid unnecessary network usage
- **Offline capability**: Process existing packages without internet connection
- **Development workflow**: Quick iterations during development

### Multiple Package Management
```bash
# Load multiple packages efficiently
just load-r4-core
just load-r5-core
just load-custom-package hl7.fhir.us.core 6.1.0

# All organized in separate directories:
# .output/packages/hl7.fhir.r4.core-4.0.1/
# .output/packages/hl7.fhir.r5.core-5.0.0/
# .output/packages/hl7.fhir.us.core-6.1.0/
```

### Format Conversion
```bash
# Convert same package to different formats
./target/release/fhirschema download --package "hl7.fhir.r4.core#4.0.1" --format json
./target/release/fhirschema download --package "hl7.fhir.r4.core#4.0.1" --format yaml

# Results in:
# .output/packages/hl7.fhir.r4.core-4.0.1/converted/schemas.json
# .output/packages/hl7.fhir.r4.core-4.0.1/converted/schemas.yaml
```

## Troubleshooting

### Common Issues

1. **Permission Errors**
   ```bash
   # Ensure write permissions
   chmod -R u+w .output/
   ```

2. **Disk Space**
   ```bash
   # Check .output directory size
   du -sh .output/
   
   # Large packages can be 10-50MB each
   ```

3. **Missing Files**
   ```bash
   # Verify package was downloaded
   ls -la .output/packages/
   
   # Check for conversion errors in logs
   ```

### Performance Considerations

- **Storage**: Each FHIR package can be 10-50MB
- **Processing**: R4 core takes ~2 seconds to process
- **Memory**: Conversion is memory-efficient, processing files individually

## Future Enhancements

- **Compression**: Automatic compression of raw files
- **Indexing**: Search index for quick schema lookup
- **Caching**: Avoid re-downloading unchanged packages
- **Cleanup**: Automatic cleanup of old package versions
